<!-- Generated by SpecStory -->

# Implement role-based access control (2025-08-06 15:55Z)

_**User**_

üìÇ  PROJECT CONTEXT
Stack: Node.js + Express + Mongoose + JWT  
Existing key files:
  ‚Ä¢ models/users.js
  ‚Ä¢ middleware/auth.js          // exports authenticate()
  ‚Ä¢ routes/userRoutes.js
Currently no role-based access control (RBAC).

üß≠  REQUIREMENTS (final)
‚Ä¢ Single flat role axis: "user" (default) | "verifiedReporter" | "moderator" | "admin"
‚Ä¢ No trust-level numbers. No admin hierarchy.
‚Ä¢ FIRST admin is created **manually** in MongoDB Atlas by adding `"role":"admin"` to a user document.
‚Ä¢ Back-end must expose one admin-only endpoint to change a user‚Äôs role.
‚Ä¢ Front-end will guard the `/admin` page client-side, but back-end must still enforce roles.

üî®  TASKS

1Ô∏è‚É£  SCHEMA ‚Äî *models/users.js*
    Insert after `password`:
    ```js
    role: {
      type: String,
      enum: ["user","verifiedReporter","moderator","admin"],
      default: "user",
    },
    ```

2Ô∏è‚É£  AUTH MIDDLEWARE ‚Äî *middleware/auth.js*
    After verifying the JWT:
      ‚Ä¢ Fetch the full user document (`select("-password")`).
      ‚Ä¢ Attach it to `req.user`.
      ‚Ä¢ If user not found ‚áí 401.
    (Identity check only ‚Äî no role logic here.)

3Ô∏è‚É£  ROLE GUARD ‚Äî *middleware/authorize.js* (NEW FILE)
    ```js
    module.exports = (...roles) => (req,res,next) => {
      if (!req.user || !roles.includes(req.user.role))
        return res.status(403).json({ error:"Forbidden" });
      next();
    };
    ```
    Keep this separate from `authenticate` for clarity.

4Ô∏è‚É£  ADMIN ENDPOINT ‚Äî *routes/userRoutes.js*
    Add:
    ```js
    // PUT /users/:id/role
    // Body: { role:"user"|"verifiedReporter"|"moderator"|"admin" }
    router.put("/:id/role",
      authenticate,
      authorize("admin"),
      async (req,res) => {
        const { role } = req.body;
        if (!["user","verifiedReporter","moderator","admin"].includes(role))
          return res.status(400).json({ error:"Unknown role" });

        // Prevent self-downgrade or self-upgrade
        if (req.user._id.equals(req.params.id))
          return res.status(400).json({ error:"Cannot change your own role" });

        const updated = await User.findByIdAndUpdate(
          req.params.id,
          { role },
          { new:true }
        ).select("-password");

        if (!updated) return res.status(404).json({ error:"User not found" });
        res.json({ message:"Role updated", user: updated });
      });
    ```

5Ô∏è‚É£  EXAMPLE OF PROTECTING OTHER ROUTES (comment only)
    ```js
    // Example:
    router.get("/admin/metrics",
      authenticate,
      authorize("admin"),
      metricsController);
    ```

6Ô∏è‚É£  README NOTE (comment block)
    ```
    # How to create the first admin
    1. Open Atlas ‚Üí Collections ‚Üí users.
    2. Edit the trusted user document.
    3. Add/modify:  "role": "admin"
    ```

‚úÖ  ACCEPTANCE CRITERIA
‚Ä¢ New sign-ups get role:"user".
‚Ä¢ Only `"admin"` accounts can hit the PUT /users/:id/role endpoint or any route wrapped in authorize("admin").
‚Ä¢ Non-admins receive 403 on protected endpoints.
‚Ä¢ Password field never leaks in responses.
‚Ä¢ No seed script required; manual Atlas edit suffices.

üì§  OUTPUT FORMAT
For **every** modified or new file emit:

while doing evrry step let me know what you are doing 

---

_**Assistant**_

I'll implement the role-based access control (RBAC) system for your Node.js + Express + Mongoose project. Let me break this down into the required tasks and implement them step by step.

---

## Todo List

- [ ] Update user schema in models/users.js to add role field with enum values
- [ ] Modify auth middleware to fetch full user document and attach to req.user
- [ ] Create new authorize middleware in middleware/authorize.js for role-based access
- [ ] Add admin endpoint PUT /users/:id/role in userRoutes.js
- [ ] Add example route protection and README notes as comments

---

Let me start by reading the current files to understand the existing structure:

---

Read file: models/users.js

---

Read file: middleware/auth.js

---

Read file: routes/userRoutes.js

---

Now I'll start implementing the RBAC system step by step. Let me begin with Task 1: updating the user schema.

---

## Todo List

- [-] Update user schema in models/users.js to add role field with enum values
- [ ] Modify auth middleware to fetch full user document and attach to req.user
- [ ] Create new authorize middleware in middleware/authorize.js for role-based access
- [ ] Add admin endpoint PUT /users/:id/role in userRoutes.js
- [ ] Add example route protection and README notes as comments

---

**Step 1: Updating the user schema in models/users.js**

I'm adding the role field after the password field with the specified enum values and default to "user":

---

<details><summary>Edit file: models/users.js</summary>

undefined

**Chunk 1**
Lines added: 6, lines removed: undefined

```diff
@@ -7,4 +7,10 @@
  
    password: { type: String, required: true },
+ 
+   role: {
+     type: String,
+     enum: ["user", "verifiedReporter", "moderator", "admin"],
+     default: "user",
+   },
  
    avatar: { type: String},
```

</details>

---

## Todo List

- [x] Update user schema in models/users.js to add role field with enum values
- [-] Modify auth middleware to fetch full user document and attach to req.user
- [ ] Create new authorize middleware in middleware/authorize.js for role-based access
- [ ] Add admin endpoint PUT /users/:id/role in userRoutes.js
- [ ] Add example route protection and README notes as comments

---

**Step 2: Modifying auth middleware to fetch full user document**

Now I'm updating the auth middleware to fetch the full user document and attach it to `req.user`:

---

<details><summary>Edit file: middleware/auth.js</summary>

undefined

**Chunk 1**
Lines added: 9, lines removed: 2

```diff
@@ -1,11 +1,18 @@
  const jwt = require("jsonwebtoken");
+ const User = require("../models/users");
  
- const authenticate = (req, res, next) => {
+ const authenticate = async (req, res, next) => {
    const token = req.headers.authorization?.split(" ")[1];
    if (!token) return res.status(403).json({ error: "Token missing" });
  
    try {
      const decoded = jwt.verify(token, process.env.JWT_SECRET);
-     req.user = decoded;
+     const user = await User.findById(decoded.id).select("-password");
+     
+     if (!user) {
+       return res.status(401).json({ error: "User not found" });
+     }
+     
+     req.user = user;
      next();
    } catch (err) {
```

</details>

---

## Todo List

- [x] Update user schema in models/users.js to add role field with enum values
- [x] Modify auth middleware to fetch full user document and attach to req.user
- [-] Create new authorize middleware in middleware/authorize.js for role-based access
- [ ] Add admin endpoint PUT /users/:id/role in userRoutes.js
- [ ] Add example route protection and README notes as comments

---

**Step 3: Creating the new authorize middleware**

Now I'm creating the new `middleware/authorize.js` file for role-based access control:

---



---

## Todo List

- [x] Update user schema in models/users.js to add role field with enum values
- [x] Modify auth middleware to fetch full user document and attach to req.user
- [x] Create new authorize middleware in middleware/authorize.js for role-based access
- [-] Add admin endpoint PUT /users/:id/role in userRoutes.js
- [ ] Add example route protection and README notes as comments

---

**Step 4: Adding the admin endpoint to userRoutes.js**

Now I'm adding the admin-only endpoint to change user roles. I need to import the authorize middleware and add the PUT /users/:id/role endpoint:

---

<details><summary>Edit file: routes/userRoutes.js</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -4,4 +4,5 @@
  const User = require("../models/users");
  const authenticate = require("../middleware/auth");
+ const authorize = require("../middleware/authorize");
  
  const router = express.Router();
```

</details>

---

Now I'll add the admin endpoint at the end of the file, before the module.exports:

---

The string to replace was not found in the file.

---

Let me check the end of the file to see the exact formatting:

---

Read file: routes/userRoutes.js

---

<details><summary>Edit file: routes/userRoutes.js</summary>

undefined

**Chunk 1**
Lines added: 33, lines removed: 2

```diff
@@ -198,6 +198,37 @@
  });
  
- 
- 
+ // PUT /users/:id/role - Admin-only endpoint to change user roles
+ // Body: { role:"user"|"verifiedReporter"|"moderator"|"admin" }
+ router.put("/:id/role",
+   authenticate,
+   authorize("admin"),
+   async (req, res) => {
+     try {
+       const { role } = req.body;
+       if (!["user", "verifiedReporter", "moderator", "admin"].includes(role)) {
+         return res.status(400).json({ error: "Unknown role" });
+       }
+ 
+       // Prevent self-downgrade or self-upgrade
+       if (req.user._id.equals(req.params.id)) {
+         return res.status(400).json({ error: "Cannot change your own role" });
+       }
+ 
+       const updated = await User.findByIdAndUpdate(
+         req.params.id,
+         { role },
+         { new: true }
+       ).select("-password");
+ 
+       if (!updated) {
+         return res.status(404).json({ error: "User not found" });
+       }
+       
+       res.json({ message: "Role updated", user: updated });
+     } catch (err) {
+       res.status(500).json({ error: "Server error" });
+     }
+   }
+ );
  
  module.exports = router;
```

</details>

---

## Todo List

- [x] Update user schema in models/users.js to add role field with enum values
- [x] Modify auth middleware to fetch full user document and attach to req.user
- [x] Create new authorize middleware in middleware/authorize.js for role-based access
- [x] Add admin endpoint PUT /users/:id/role in userRoutes.js
- [-] Add example route protection and README notes as comments

---

**Step 5: Adding example route protection and README notes**

Now I'll add example comments showing how to protect other routes and add README notes about creating the first admin:

---

<details><summary>Edit file: routes/userRoutes.js</summary>

undefined

**Chunk 1**
Lines added: 21, lines removed: undefined

```diff
@@ -231,4 +231,25 @@
    }
  );
+ 
+ // Example of protecting other routes with role-based access:
+ // router.get("/admin/metrics",
+ //   authenticate,
+ //   authorize("admin"),
+ //   metricsController);
+ //
+ // router.get("/moderator/reports",
+ //   authenticate,
+ //   authorize("moderator", "admin"),
+ //   reportsController);
+ 
+ /*
+ # How to create the first admin
+ 1. Open MongoDB Atlas ‚Üí Collections ‚Üí users.
+ 2. Edit the trusted user document.
+ 3. Add/modify: "role": "admin"
+ 
+ Note: New sign-ups automatically get role: "user"
+ Only admin accounts can access the PUT /users/:id/role endpoint
+ */
  
  module.exports = router;
```

</details>

---

## Todo List

- [x] Update user schema in models/users.js to add role field with enum values
- [x] Modify auth middleware to fetch full user document and attach to req.user
- [x] Create new authorize middleware in middleware/authorize.js for role-based access
- [x] Add admin endpoint PUT /users/:id/role in userRoutes.js
- [x] Add example route protection and README notes as comments

---

Let me check for any linting errors in the files I've modified:

---



---

Perfect! I've successfully implemented the complete role-based access control (RBAC) system for your Node.js + Express + Mongoose project. Here's a summary of all the changes made:

## ‚úÖ **COMPLETED IMPLEMENTATION**

### **1Ô∏è‚É£ Schema Updated** - `models/users.js`
- Added `role` field after password with enum values `["user", "verifiedReporter", "moderator", "admin"]`
- Default value set to `"user"` for new registrations

### **2Ô∏è‚É£ Auth Middleware Enhanced** - `middleware/auth.js`
- Modified to fetch full user document from database (not just JWT payload)
- Attaches complete user object to `req.user` with password excluded
- Returns 401 if user not found in database

### **3Ô∏è‚É£ Role Guard Created** - `middleware/authorize.js` (NEW FILE)
- Separate middleware for role-based access control
- Takes variable number of allowed roles as parameters
- Returns 403 Forbidden if user doesn't have required role

### **4Ô∏è‚É£ Admin Endpoint Added** - `routes/userRoutes.js`
- New `PUT /users/:id/role` endpoint protected by admin-only access
- Validates role values against enum
- Prevents self-role modification (security feature)
- Returns updated user object without password

### **5Ô∏è‚É£ Documentation & Examples** - `routes/userRoutes.js`
- Added example route protection patterns in comments
- Included README-style instructions for creating first admin
- Clear documentation of the manual MongoDB Atlas setup process

## üîí **Security Features Implemented**

- ‚úÖ New users default to `"user"` role
- ‚úÖ Only admins can change user roles via API
- ‚úÖ Users cannot change their own roles (prevents privilege escalation)
- ‚úÖ Password field never exposed in API responses
- ‚úÖ JWT tokens verified and users validated against database
- ‚úÖ Role validation with proper enum constraints

## üöÄ **Ready to Use**

Your RBAC system is now fully functional! To create your first admin:

1. Register a user through your normal registration process
2. Go to MongoDB Atlas ‚Üí Collections ‚Üí users
3. Find that user's document and edit it
4. Add/modify the field: `"role": "admin"`

The admin can then use the `PUT /users/:id/role` endpoint to assign roles to other users. All routes can now be protected using the `authorize("role1", "role2")` middleware pattern shown in the examples.

---

_**User**_

WANT TO run user page 
in user role 
how can i do that 

---

_**Assistant**_

I see you want to run the user page in the user role context. I notice that you've made some changes to the models and routes, but it looks like you removed the admin role endpoint. Let me help you understand how to test the user role functionality.

Let me first check the current state of your files and then help you set up testing for the user role:

---

Read file: undefined

---

Read file: undefined

---

I can see you have a React frontend with an API service that's expecting admin endpoints. Since you removed the admin role endpoint from the backend, let me help you understand how to test the user role functionality and suggest what you might need.

---

## Todo List

- [ ] Re-add the admin role endpoint that was removed
- [ ] Add admin endpoints for verification management
- [ ] Test user role functionality

---

