<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="dashboard.css" />
    <link rel="stylesheet" href="menu.css" />
  </head>
  <body>
    <div class="menu">
      <div class="logo">
        <div class="com">Commute</div>
        <div class="bud">Buddy</div>
      </div>
      <div class="name">
        <img id="avatar" src="" alt="Avatar" />
        <h1><span id="username"></span></h1>
      </div>
      <p>Email: <span id="email"></span></p>

      <a href="user.html" class="user">User Profile</a>
      <a href="dashboard.html" class="update">Update Profile </a>
      <button id="logoutBtn">Logout</button>
    </div>

    <div class="container">
      <h2>Update Profile</h2>
      <input type="text" id="homeLocation" placeholder="Home Location" />
      <input type="text" id="workLocation" placeholder="Work Location" />
      <input
        type="text"
        id="preferredRegions"
        placeholder="Preferred Regions (comma separated)"
      />

      <input type="file" name="avatar" id="avatarInput" accept="image/*" />
      <button id="updateProfileBtn">Update Profile</button>

      <h2>Followed Routes</h2>
      <input
        type="text"
        id="followedRoutes"
        placeholder="Followed Routes (comma separated)"
      />
      <button id="updateRoutesBtn">Update Routes</button>
    </div>

    <script>
      // Get token and userId from localStorage
      const token = localStorage.getItem("token");
      const userId = localStorage.getItem("userId");

      if (!token || !userId) {
        console.log("Token or userId missing", token, userId);
        window.location.href = "index.html";
      }

      const axiosConfig = { headers: { Authorization: `Bearer ${token}` } };

      // Fetch user profile
      async function fetchProfile() {
        try {
          const res = await axios.get(
            `https://commute-buddy-fegt.onrender.com/api/users/${userId}`,
            axiosConfig
          );
          const user = res.data;

          document.getElementById("username").innerText = user.name;
          document.getElementById("email").innerText = user.email;
          document.getElementById("avatar").src =
            user.avatar || "default-avatar.png";
          document.getElementById("homeLocation").value =
            user.homeLocation || "";
          document.getElementById("workLocation").value =
            user.workLocation || "";
          document.getElementById("preferredRegions").value =
            user.preferredRegions.join(", ") || "";
          document.getElementById("followedRoutes").value =
            user.followedRoutes.join(", ") || "";
        } catch (err) {
          console.error("Fetch profile error:", err.response?.data);
          alert("Session expired or unauthorized. Please login again.");
          localStorage.removeItem("token");
          localStorage.removeItem("userId");
          window.location.href = "index.html";
        }
      }

      fetchProfile();

      // Update profile (locations & preferred regions)
      document
        .getElementById("updateProfileBtn")
        .addEventListener("click", async () => {
          const homeLocation = document.getElementById("homeLocation").value;
          const workLocation = document.getElementById("workLocation").value;
          const preferredRegions = document
            .getElementById("preferredRegions")
            .value.split(",")
            .map((r) => r.trim());

          const avatarFile = document.getElementById("avatarInput").files[0];
          if (avatarFile) {
            const formData = new FormData();
            formData.append("avatar", avatarFile);
            await axios.post(
              `https://commute-buddy-fegt.onrender.com/api/users/${userId}/avatar`,
              formData,
              {
                headers: {
                  ...axiosConfig.headers,
                  "Content-Type": "multipart/form-data",
                },
              }
            );
          }

          try {
            await axios.put(
              `https://commute-buddy-fegt.onrender.com/api/users/${userId}/locations`,
              { homeLocation, workLocation },
              axiosConfig
            );
            await axios.put(
              `https://commute-buddy-fegt.onrender.com/api/users/${userId}/preferred-regions`,
              { regions: preferredRegions },
              axiosConfig
            );

            //Always fetch fresh user info after update
            const res = await axios.get(
              `https://commute-buddy-fegt.onrender.com/api/users/${userId}`,
              axiosConfig
            );
            localStorage.setItem("userData", JSON.stringify(res.data));

            alert("Profile updated successfully!");
          } catch (err) {
            console.error("Update profile error:", err.response?.data);
            alert("Failed to update profile");
          }
        });

      // Update followed routes
      document
        .getElementById("updateRoutesBtn")
        .addEventListener("click", async () => {
          const routes = document
            .getElementById("followedRoutes")
            .value.split(",")
            .map((r) => r.trim());

          try {
            await axios.put(
              `https://commute-buddy-fegt.onrender.com/api/users/${userId}/followed-routes`,
              { routes },
              axiosConfig
            );
            // Fetch latest user info and save to localStorage
            const res = await axios.get(
              `https://commute-buddy-fegt.onrender.com/api/users/${userId}`,
              axiosConfig
            );
            localStorage.setItem("userData", JSON.stringify(res.data));

            alert("Followed routes updated successfully!");
          } catch (err) {
            console.error("Update routes error:", err.response?.data);
            alert("Failed to update routes");
          }
        });

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("token");
        localStorage.removeItem("userId");
        window.location.href = "index.html";
      });
    </script>
  </body>
</html>
